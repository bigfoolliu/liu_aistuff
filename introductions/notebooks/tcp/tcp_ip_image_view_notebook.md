# 图解Tcp/Ip

<!-- TOC -->

- [图解Tcp/Ip](#图解tcpip)
    - [1.网络基础知识](#1网络基础知识)
        - [1.1计算机中的协议](#11计算机中的协议)
        - [1.2协议中的七层通信](#12协议中的七层通信)
        - [1.3传输方式的分类](#13传输方式的分类)
            - [1.3.1面向有连接和面向无连接](#131面向有连接和面向无连接)
            - [1.3.2电路交换和分组交换](#132电路交换和分组交换)
            - [1.3.3单播，广播，多播，任播](#133单播广播多播任播)
        - [1.4地址](#14地址)
        - [1.5网络的构成要素](#15网络的构成要素)
    - [2.TCP/IP](#2tcpip)
        - [2.1TCP/IP协议基础知识](#21tcpip协议基础知识)
            - [2.1.1应用协议](#211应用协议)
            - [2.1.2路由控制协议](#212路由控制协议)
            - [2.2.2传输协议](#222传输协议)
            - [2.2.3网际协议](#223网际协议)
        - [2.2TCP/IP分层模型和通信示例](#22tcpip分层模型和通信示例)
    - [3.数据链路](#3数据链路)
    - [4.IP协议](#4ip协议)
        - [4.1IP基础知识](#41ip基础知识)
            - [4.2关于以太网](#42关于以太网)
        - [4.3IP地址](#43ip地址)
    - [5.IP协议相关技术](#5ip协议相关技术)
        - [5.1DNS](#51dns)
        - [5.2域名和域名服务器](#52域名和域名服务器)
        - [5.3ARP](#53arp)
        - [5.4DHCP](#54dhcp)
        - [5.5NAT](#55nat)
        - [5.6IP隧道](#56ip隧道)
    - [6.TCP和UDP](#6tcp和udp)
        - [6.1端口号](#61端口号)
        - [6.2UDP](#62udp)
        - [6.3TCP](#63tcp)
        - [6.4其他传输层协议](#64其他传输层协议)
    - [7.路由协议](#7路由协议)
        - [7.1静态路由和动态路由](#71静态路由和动态路由)

<!-- /TOC -->

## 1.网络基础知识

OSI七层模型:

![osi七层模型图](./images/osi_model.png)

计算机与网络发展的七个阶段：

1. 批处理时代
    事先将用户程序和数据装入卡带和磁带，由计算机按照一定的顺序读取.
2. 分时系统时代
    TSS,多终端与同一个计算机连接，允许多个用户同时使用一台计算机.
3. 计算机间通信时代
4. 计算机网络的产生
    基于分组交换技术的计算机网络.
5. 互联网的普及时代
    一人一机.
6. 以互联网技术为中心的时代
7. 从"单纯建立连接"到"安全建立连接"，一切皆TCP/IP时代

### 1.1计算机中的协议

协议就是计算机与计算机之间通过网络通信事先达成的一种“约定”，让不同厂商的设备，不同CPU以及不同操作系统之间可以通信。

互联网中协议：IP,TCP,HTTP
局域网中协议：IPX/SPX

**分组交换协议**：指将大数据分割为一个个较小单位的包(package)传输，每个包带着标签(报文首部).

**协议分层**：根据OSI模型，每一个分层都接收由它下一层所提供的特定服务，并且负责为自己的上一层提供特定的服务，上下层之间进行交互时遵循的约定叫"接口"，同一层之间的约定叫“协议”。

![OSI参考模型中个分层的作用](./images/osi_function.png)

### 1.2协议中的七层通信

![osi模块化通信](./images/osi_transport.png)

### 1.3传输方式的分类

#### 1.3.1面向有连接和面向无连接

**面向有连接**：发送数据之前需要在主机之间连接一条`通信线路`，传输完成之后断开连接。

**面向无连接**：不需要建立和断开连接，发送端可在任何时候自由发送数据，接收端也永远不知道自己会在何时从哪里接收数据，因此接收端需要市场确认收到数据。

#### 1.3.2电路交换和分组交换

**电路交换**： `交换机`负责数据中转处理，计算机通信需要通过交换机建立独占的线路进行连接。

**分组交换**：让连接到通信线路的计算机将所要发送的数据分成`多个数据包，按照顺序排列之后分别发送`，所有的计算机可以一齐收发数据。

#### 1.3.3单播，广播，多播，任播

### 1.4地址

- MAC地址
    `真正负责最终通信的地址`，但是对于寻址没有作用。通过制造商，制造商内部产品编号以及产品通用编号保证MAC地址的唯一性。
- IP地址

### 1.5网络的构成要素

![网络硬件构成要素](./images/net_strcture.png)

**传输速率**：单位时间内传输的数据量，又叫带宽，单位为bps。
**吞吐量**：主机之间实际的传输速率，单位同带宽，但是包括计算机的CPU处理能力。

## 2.TCP/IP

### 2.1TCP/IP协议基础知识

大部分时候指代一个`协议族`：

#### 2.1.1应用协议

工作在应用层的协议。

- **HTTP**，WWW
- **SMTP**，邮件发送
- **FTP**，文件传输
- **TELNET**，远程登录
- **SNMP**，网络管理
- **SSH**，远程登录

#### 2.1.2路由控制协议

- **RIP**
- **OSPF**
- **BGP**

#### 2.2.2传输协议

- **TCP**, 面向有连接的传输层协议，保证通信主机之间的通信可达。
- **UDP**, 面向无连接的传输层协议，不会关注对端是否真的收到传送过去的数据。

#### 2.2.3网际协议

- **IP**, 跨越网络传送数据包的协议，属于分组交换的协议，但是没有重发机制，即分组数据包未能到达对端主机也不会重发。
- **ICMP**, IP数据包在发送途中发生异常时给发送端发一个发生异常的通知。
- **ARP**, 从分组数据包的IP地址中解析物理地址的协议。

### 2.2TCP/IP分层模型和通信示例

- `包`：全能性术语
- `帧`：表示数据链路层中`包的单位`
- `数据报`：指IP和UDP等`网络层以上的分层中包的单位`
- `段`：表示TCP数据流中的信息
- `消息`：应用协议中数据的单位

![数据传送流程](./images/tcp_transport2.png)

## 3.数据链路

数据链路层的协议规定了`通过通信媒介互连的设备之间传输的规范`，交换机工作在这层。

半双工：
    只发送或只接收的通信方式。
全双工：
    允许在同一时间既可以发送数据也可以接受数据。

## 4.IP协议

### 4.1IP基础知识

`主机`：配有IP地址但是不进行路由控制的设备，可以是超大型机，也可以是小型机。
`路由器`：配置有IP地址，同时进行路由控制的设备。
`节点`：主机和路由器的统称。
`路由`：指分组从源到目的地时，决定端到端路径的网络范围的进程。

**IP三大作用：**

- IP寻址
- 路由(最终节点为止的转发)
- IP分包和组包

`跳(Hop)`：指的是网络中的一个区间，IP包在网络中一个个跳间被转发。
`路由控制表`：主机维护的一张路由控制表，该表记录IP数据在下一步应该发送给哪个路由器。IP包根据这个路由表在各个数据链路上传输。

IP是实现多个数据链路之间通信的协议，不同数据链路之间有个最大的区别就是各自最大传输单位(MTU)不同，在以太网中是1500字节，在FDDI中是4352字节。

IP属于面向无连接型，为了简化以及提速。

#### 4.2关于以太网

现阶段成熟的局域网技术三种:

- 以太网(Ethernet),使用CSMA/CD（载波监听多路访问及冲突检测）技术
- 令牌环(Token Ring)
- 光纤分布式数据接口(FDDI)

### 4.3IP地址

IPv4由32位正整数表示，**IP地址不是根据主机台数配置，而是每一台主机上的每一块网卡(NIC)都得设置，一块网卡也可以设置多个IP地址**。

分配IP地址时，比特位表示主机地址，不可以全0或全1，全0只有在表示对应的网络地址或IP地址为不可获知的情况下才使用，全1的主机地址通常表示为广播地址。

## 5.IP协议相关技术

### 5.1DNS

- 原始使用`主机识别码`，用一个hosts的数据库文件集中管理主机名与IP地址对应的表。
- DNS系统就是一个可以`有效管理主机名和IP地址之间对应关系的系统`，用户输入主机名（域名）时，DNS自动检索注册了该主机名和IP地址的数据库来定位对应的IP地址。

### 5.2域名和域名服务器

- `域名`是为了识别主机名称和组织机构名称的一种具有分层的名称。`域名服务器`则是可以管理所在分层的域的相关信息的主机和相应的软件。
- `解析器`指的是进行DNS查询的主机和软件。

### 5.3ARP

`ARP`是一种解决地址问题的协议，以目标IP来定位下一个应该接收数据分包的网络设备对应的MAC地址。

### 5.4DHCP

- 为了实现自动设置IP地址，统一管理IP地址分配产生的协议
- DHCP服务器来分配，家庭以太网中通常由路由器来承当
- 当有多个以太网（无线LAN）网段时，通过`DHCP中继代理`，一个DHCP服务器来管理多个中继代理实现。

### 5.5NAT

指用于在本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。通过NAT路由器来实现。

### 5.6IP隧道

为了解决IPv4和IPv6的通信，可以将IPv6的包统和为一个数据，然后追加一个IPv4的首部以后转发。

## 6.TCP和UDP

- TCP面向有连接，且具备顺序控制，重发控制等机制，但是数据在传动途中间丢失就会重发，会导致延迟等。
- UDP主要用于高速传输和实时性要求高的场景，部分数据丢失不会重发。

### 6.1端口号

端口号用来识别同一台计算机中进行通信的不同应用程序，也叫`程序地址`。

### 6.2UDP

利用IP提供面向无连接的通信服务，将应用程序发来的数据收到的那刻立即原样发送到网络上。不负责重发，包顺利乱掉也不会纠正，细节控制则交给UDP的应用程序处理。

**UDP应用场景：**

1. 包总量较少的通信(DNS, SNMP等)
2. 视频，音频等多媒体通信(即时通信)
3. 限定于LAN等特定网络中的应用通信
4. 广播通信(广播，多播等)

UDP组成：

- 首部
  - 源端口号
  - 目标端口号
  - 包长度
  - 校验和（判断协议首部和数据是否被破坏）
- 数据

### 6.3TCP

- 面向有连接，可以进行丢包时候的重发控制，还可以对次序乱掉的分包进行顺序控制。
- `连接`指各种设备，线路，或网络中进行通信的两个应用程序为了相互传递消息而专有的，虚拟的通信线路，也叫`虚拟电路`。TCP则负责控制连接的建立，断开，保持等管理工作。

特点：

- TCP通过检验和，序列号，确认应答，重发控制，连接管理以及窗口控制等机制实现可靠性传输
- 接收端返回收到消息的通知，这个消息叫`确认应答(ACK)`
- 发送端一定时间内没有等到确认应答，可以认为数据已经丢失，并进行**重发**
- 发送端一定时间内没有等到确认应答，可能是发送数据丢失，也可能是返回的确认应答在途中丢失

TCP组成：

- 首部
  - 源端口号
  - 目标端口号
  - 序列号
  - 确认应答号
  - 数据偏移（表示TCP传输的数据部分应该从TCP的哪个包开始计算）
  - 保留（为了以后扩展使用）
  - 控制位
  - 窗口大小
  - 校验和
  - 紧急指针
  - 选项
- 数据

### 6.4其他传输层协议

- UDP-Lite
    轻量级用户数据报协议，扩展UDP机能的一种传输层协议。
- SCTP
    流控制传输协议，与TCP一样都是一种提供数据到达与否相关可靠性检查的传输层协议。
- DCCP
    数据包拥塞控制协议，一个辅助UDP的崭新的传输层协议。

## 7.路由协议

路由器在途中正确转发数据到地址所进行的处理就是`路由控制或路由`。

### 7.1静态路由和动态路由

`静态路由`是事先设置好路由器和主机中并将路由信息固定的方法。`动态`路由是让路由协议在运行过程中自动设置路由控制信息的一种方法。
