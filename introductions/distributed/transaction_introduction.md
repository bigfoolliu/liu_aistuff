# 分布式事务

<!-- vim-markdown-toc Marked -->

* [1.概述](#1.概述)
* [2.相关技术理论](#2.相关技术理论)
    - [2.1CAP定理](#2.1cap定理)
    - [2.2BASE理论](#2.2base理论)
* [3.分布式事务实现方案](#3.分布式事务实现方案)
    - [3.1基于数据库资源层面](#3.1基于数据库资源层面)
    - [3.2基于业务层面](#3.2基于业务层面)

<!-- vim-markdown-toc -->

## 1.概述

- `事务`, 是数据库管理系统执行过程中的一个逻辑单位，由一个`有限的数据库操作序列构成`
- 事务的四个特性：`ACID`
- `分布式事务`，涉及多个网络主机的数据库事务
- [掘金：分布式事务](https://juejin.cn/post/6914894669126533133#heading-6)

## 2.相关技术理论

### 2.1CAP定理

一个分布式系统（指互相连接并共享数据的节点的集合）中，当`涉及读写操作时`，只能保证`一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个`，另外一个必须被牺牲，但其中的`P分区容错性基本上是必需的，所以只能取CP或者AP`。

### 2.2BASE理论

- `Basically Available（基本可用）`：分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用
- `Soft state（软状态）`：允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致
- `Eventually consistent（最终一致性）`：最终一致是指经过一段时间后，所有节点数据都将会达到一致

## 3.分布式事务实现方案

- [知乎：分布式事务的六种解决方案](https://zhuanlan.zhihu.com/p/183753774)

### 3.1基于数据库资源层面

基于`协调者`(多个事务的管理的角色)与`参与者`(事务参与者)的思想设定，在`XA协议下`，分别提出了 2PC 与 3PC 实现XA 分布式事务.

1. 2PC 两阶段提交协议, 
    - 第一阶段，协调者(事务管理器)将涉及到事务的进行预提交，这个时候数据库资源开始被锁定。参与者将 undo 与 redo 写入事务日志
    - 第二阶段，参与者（资源管理器）行提交事务，或者利用 undo 日志回滚事务，释放资源。
    - 优点：实现简单，强一致性
    - 缺点：协调者单点问题(若协调者在提交阶段宕机，参与者一直在等待,就一直锁定资源，一直阻塞); 同步阻塞时间过长，整个执行过程事务是阻塞的; 数据不一致
2. 3PC 三阶段提交协议

### 3.2基于业务层面

TCC事务

- `Trying`, 完成所有业务检查(一致性)；预留必须业务资源(准隔离性)
- `Confirm`.  真正执行业务， Confirm操作要满足幂等性
- `Cancel`,  释放Try阶段预留的业务资源，Cancel操作要满足幂等性
- `基于业务层面`的事务，锁的粒度由业务代码控制

