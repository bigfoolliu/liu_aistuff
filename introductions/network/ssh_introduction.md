# ssh

<!-- vim-markdown-toc Marked -->

* [1.概述](#1.概述)
* [2.ssh客户端](#2.ssh客户端)
    - [2.1基本用法](#2.1基本用法)
    - [2.2连接流程](#2.2连接流程)
    - [2.3客户端配置](#2.3客户端配置)
    - [2.4主机配置](#2.4主机配置)
* [3.ssh密钥登陆](#3.ssh密钥登陆)
    - [3.1密钥介绍](#3.1密钥介绍)
    - [3.2密钥登录过程](#3.2密钥登录过程)
* [4.ssh服务器](#4.ssh服务器)
    - [4.1简介](#4.1简介)
    - [4.2sshd配置项](#4.2sshd配置项)
* [5.端口转发](#5.端口转发)
    - [5.1端口转发类型](#5.1端口转发类型)
* [6.ssh证书登录](#6.ssh证书登录)
    - [6.1证书登录与非证书登录对别](#6.1证书登录与非证书登录对别)
    - [6.2证书登录特点](#6.2证书登录特点)
    - [6.3证书登录流程](#6.3证书登录流程)
* [7.其他配置](#7.其他配置)
    - [7.1iterm2连接远程服务器短时间就断开](#7.1iterm2连接远程服务器短时间就断开)

<!-- vim-markdown-toc -->

## 1.概述

- secure shell, linux系统的登录工具
- 能够加密计算机之间的通信，保证不被窃听或篡改。它还能对操作者进行认证（authentication）和授权（authorization）。明文的网络协议可以套用在它里面，从而实现加密.
- 架构：`服务器-客户端模式（Server - Client）`

## 2.ssh客户端

### 2.1基本用法

```sh
# 一般位置在/usr/local/bin/ssh, ubuntu安装
sudo apt install openssh-client

# 查看版本
ssh -V


# 连接服务器
# hostname是主机名，它可以是域名，也可能是 IP 地址或局域网内部的主机名。不指定用户名的情况下，将使用客户端的当前用户名，作为远程服务器的登录用户名
ssh hostname
ssh user@hostname  # 指定user

ssh user@hostname ls /etc/  # 执行远程命令,此种立即执行
ssh -t user@hostname emacs  # 可以执行交互式的命令

ssh -l username host  # 另一种格式

ssh -p 2201 hostname  # 端口默认为22，可以指定其他端口 
```

### 2.2连接流程

1. 连接远程服务器之后，首先是一个验证`服务器指纹(SSH 服务器公钥的哈希值, 每台 SSH 服务器都有唯一一对密钥，用于跟客户端通信，其中公钥的哈希值就可以用来识别服务器)`的过程
2. 验证之后就可以建立连接

### 2.3客户端配置

```sh
/etc/ssh/ssh_config  # 全局配置文件
~/.ssh/config  # 个人配置文件，优先级高于全局配置文件

~/.ssh/id_ecdsa  # 用户的 ECDSA 私钥。
~/.ssh/id_ecdsa.pub  # 用户的 ECDSA 公钥

~/.ssh/id_rsa  # 用于 SSH 协议版本2 的 RSA 私钥。
~/.ssh/id_rsa.pub  # 用于SSH 协议版本2 的 RSA 公钥

~/.ssh/identity  # 用于 SSH 协议版本1 的 RSA 私钥
~/.ssh/identity.pub  # 用于 SSH 协议版本1 的 RSA 公钥

~/.ssh/known_hosts  # 包含 SSH 服务器的公钥指纹
```

### 2.4主机配置

```sh
# 个人配置文件中， ~/.ssh/config， 配置可以不必登录服务器输入重复的参数
# Host * 针对所有的主机配置, 也可以写作 Port=223
Host *
    Port 223

# 执行ssh server1则等价于 ssh -p 221 root@exp.com
Host server1
    HostName exp.com
    User root
    Port 221

```

## 3.ssh密钥登陆

### 3.1密钥介绍

- 一个非常大的数字，通过加密算法得到
- 对称加密只需要一个密钥，非对称加密需要两个密钥成对使用，分为公钥（public key）和私钥（private key）
- ssh密钥登录使用非对称加密，私钥私密保存，公钥可公开
- 公钥加密，那么只有使用对应的私钥才能解密，其他密钥都不行；反过来，如果使用`私钥加密（这个过程一般称为“签名”），也只有使用对应的公钥解密`

### 3.2密钥登录过程

1. 客户端通过`ssh-keygen`生成自己的公钥和私钥
2. 手动将客户端的`公钥放入远程服务器的指定位置`
3. 客户端向服务器发起 SSH 登录的请求
4. 服务器收到用户 SSH 登录的请求，发送一些随机数据给用户，要求用户证明自己的身份
5. 客户端收到服务器发来的数据，使用私钥对数据进行签名，然后再发还给服务器
6. 服务器收到客户端发来的加密签名后，使用对应的公钥解密，然后跟原始数据比较。如果一致，就允许用户登录

```sh
# 生成公钥和私钥
# -t  指定加密算法
# -b  指定加密强度，越大约难被破解，但是影响开销
# -C  参数可以为密钥文件指定新的注释
ssh-keygen -t rsa -b 4096 -C "your_email@domain.com"
```

## 4.ssh服务器

### 4.1简介

- 服务端使用软件是`sshd`

```sh
# ubunut安装sshd
sudo aoy-get install openssh-server


# sshd默认随系统系统启动，手动开启为


$ sudo systemctl start sshd.service  # 启动
$ sudo systemctl stop sshd.service  # 停止
$ sudo systemctl restart sshd.service  # 重启

$ sudo systemctl enable sshd.service  # 让 sshd 在计算机下次启动时自动运行
```

### 4.2sshd配置项

```sh
# /etc/ssh/sshd_config文件里面的配置项

AllowGroups groupName  # 指定允许登录的用户组，多个组之间用空格分隔。如果不使用该项，则允许所有用户组登录
AllowUsers  # 指定允许登录的用户，多个用户用空格分开，也可以用多行

DenyUsers user1  # 指定不允许登录的用户，用户名之间使用空格分隔，也可以使用多行DenyUsers命令指定
```

## 5.端口转发

### 5.1端口转发类型

- `动态转发`, 本机与 SSH 服务器之间创建了一个加密连接，然后`本机内部针对某个端口的通信，都通过这个加密连接转发`
- `本地转发`, SSH 服务器作为中介的跳板机，建立本地计算机与特定目标网站之间的加密连接
- `远程转发`, 主要针对内网, 本地计算机在外网，SSH 跳板机和目标服务器都在内网，而且本地计算机无法访问内网之中的 SSH 跳板机，但是 SSH 跳板机可以访问本机计算机

## 6.ssh证书登录

### 6.1证书登录与非证书登录对别

- 非证书登录：密码登录存在被暴力破解的风险，密钥登录需要服务器保存用户的公钥，对于多用户多服务器不方便，离职员工还要将其公钥从每太服务器删除
- 证书登录：引入了一个`证书颁发机构（Certificate Authority，简称 CA）`，对信任的服务器颁发服务器证书，对信任的用户颁发用户证书

### 6.2证书登录特点

- 登录时，用户和服务器不需要提前知道彼此的公钥，`只需要交换各自的证书`，验证是否可信,更容易管理，也具有更好的扩展性
- 证书`可以设置到期时间`，而公钥没有到期时间。针对不同的情况，可以设置有效期很短的证书，进一步提高安全性

### 6.3证书登录流程

先生成证书：

1. 用户和服务器都将自己的公钥，发给 CA；
2. CA 使用服务器公钥，生成服务器证书，发给服务器
3. CA 使用用户的公钥，生成用户证书，发给用户

用户登录：

1. 用户登录服务器时，SSH 自动将用户证书发给服务器
2. 服务器检查用户证书是否有效，以及是否由可信的 CA 颁发。证实以后，就可以信任用户
3. SSH 自动将服务器证书发给用户
4. 用户检查服务器证书是否有效，以及是否由信任的 CA 颁发。证实以后，就可以信任服务器
5. 双方建立连接，服务器允许用户登录

## 7.其他配置

### 7.1iterm2连接远程服务器短时间就断开

```sh
# /etc/ssh/ssh_config
# 配置放置服务器自动断开
ServerAliveInterval 60

# /etc/ssh/sshd_config
# 数值是秒 可以随意设置,  如果发现客户端没有响应, 则判断一次超时，参数设置是允许超时次数
ClientAliveInterval 600
ClientAliveCountMax 10
```

